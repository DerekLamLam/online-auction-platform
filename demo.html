// Global array to store listener unsubscribe functions
let listeners = [];

function loadUsers() {
    const usersRef = ref(db, 'onlineAuction/users');
    const unsubscribe = onValue(usersRef, (snapshot) => {
        const usersList = document.getElementById('usersList');
        usersList.innerHTML = "";
        if (!snapshot.exists()) {
            console.log("No users found in the database.");
            usersList.innerHTML = "<p>No users found.</p>";
            return;
        }

        snapshot.forEach(userSnapshot => {
            const user = userSnapshot.val();
            const userId = userSnapshot.key;
            console.log("User data:", userId, user);
            const userDiv = document.createElement('div');
            userDiv.innerHTML = `
                <p>${user.username} (${user.email})</p>
                <button class="delete-button" data-userid="${userId}">Delete User</button>
                <button class="edit-button" data-userid="${userId}">Edit User</button>
                <div id="editForm-${userId}" class="edit-form">
                    <form data-userid="${userId}">
                        <label for="username-${userId}">Username:</label>
                        <input type="text" id="username-${userId}" value="${user.username}" required>

                        <label for="hkid-${userId}">HKID Number:</label>
                        <input type="text" id="hkid-${userId}" value="${user.hkid || ''}" required>

                        <label for="fullname-${userId}">Fullname:</label>
                        <input type="text" id="fullname-${userId}" value="${user.fullname || ''}" required>

                        <label for="phonenum-${userId}">Phone Number:</label>
                        <input type="tel" id="phonenum-${userId}" value="${user.phoneNumber || ''}" required>

                        <label for="address-${userId}">Address:</label>
                        <input type="text" id="address-${userId}" value="${user.address || ''}" required>

                        <button type="submit">Save Changes</button>
                    </form>
                </div>
            `;
            usersList.appendChild(userDiv);
        });

        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', () => {
                const userId = button.getAttribute('data-userid');
                deleteUser(userId);
            });
        });

        document.querySelectorAll('.edit-button').forEach(button => {
            button.addEventListener('click', () => {
                const userId = button.getAttribute('data-userid');
                toggleEditForm(userId);
            });
        });

        document.querySelectorAll('.edit-form form').forEach(form => {
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                const userId = form.getAttribute('data-userid');
                updateUser(event, userId);
            });
        });
    }, (error) => {
        console.error("Error loading users:", error.message);
        alert("Error loading users: " + error.message);
    });

    // Store the unsubscribe function
    listeners.push(unsubscribe);
}

function populateUserSelect() {
    const usersRef = ref(db, 'onlineAuction/users');
    const unsubscribe = onValue(usersRef, (snapshot) => {
        const userSelect = document.getElementById('userSelect');
        userSelect.innerHTML = '<option value="">Select a user</option>';
        if (!snapshot.exists()) {
            console.log("No users found for dropdown.");
            return;
        }
        snapshot.forEach(userSnapshot => {
            const user = userSnapshot.val();
            const userId = userSnapshot.key;
            const option = document.createElement('option');
            option.value = userId;
            option.text = `${user.username} (${user.email})`;
            userSelect.appendChild(option);
        });
    }, (error) => {
        console.error("Error populating user dropdown:", error.message);
    });

    // Store the unsubscribe function
    listeners.push(unsubscribe);
}

function loadAllItems() {
    const usersRef = ref(db, 'onlineAuction/users');
    const unsubscribeUsers = onValue(usersRef, (snapshot) => {
        const itemList = document.getElementById('itemList');
        itemList.innerHTML = '';
        if (!snapshot.exists()) {
            console.log("No users or items found in the database.");
            itemList.innerHTML = "<p>No items found.</p>";
            return;
        }

        snapshot.forEach((userSnapshot) => {
            const userId = userSnapshot.key;
            const user = userSnapshot.val();
            const itemsRef = ref(db, `onlineAuction/users/${userId}/auction-items`);
            const unsubscribeItems = onValue(itemsRef, (itemSnapshot) => {
                if (!itemSnapshot.exists()) {
                    return;
                }
                itemSnapshot.forEach((itemChildSnapshot) => {
                    const item = itemChildSnapshot.val();
                    const itemId = itemChildSnapshot.key;

                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('item');
                    itemDiv.innerHTML = `
                        <h3>${item.name}</h3>
                        <p>Owner: ${user.username} (${user.email})</p>
                        <div>
                            <label>Item Name:</label>
                            <input type="text" value="${item.name}" id="name-${userId}-${itemId}">
                        </div>
                        <div>
                            <label>Description:</label>
                            <textarea id="description-${userId}-${itemId}">${item.description}</textarea>
                        </div>
                        <div>
                            <label>Starting Price:</label>
                            <input type="number" value="${item.price}" id="price-${userId}-${itemId}">
                        </div>
                        <div>
                            <label>Current Image:</label>
                            <img src="${item.imageUrl || ''}" alt="Item Image">
                        </div>
                        <div>
                            <label>Change Image:</label>
                            <input type="file" id="image-${userId}-${itemId}" accept="image/*">
                        </div>
                        <div>
                            <label>Auction End Time:</label>
                            <input type="datetime-local" value="${new Date(item.endTime).toISOString().slice(0, 16)}" id="endTime-${userId}-${itemId}">
                        </div>
                        <button class="save-item-button" data-userid="${userId}" data-itemid="${itemId}">Save Changes</button>
                        <button class="delete-item-button" data-userid="${userId}" data-itemid="${itemId}">Delete</button>
                    `;
                    itemList.appendChild(itemDiv);
                });

                document.querySelectorAll('.save-item-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const userId = button.getAttribute('data-userid');
                        const itemId = button.getAttribute('data-itemid');
                        editItem(userId, itemId);
                    });
                });

                document.querySelectorAll('.delete-item-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const userId = button.getAttribute('data-userid');
                        const itemId = button.getAttribute('data-itemid');
                        deleteItem(userId, itemId);
                    });
                });
            }, (error) => {
                console.error("Error loading items for user", userId, ":", error.message);
            });

            // Store the unsubscribe function for items
            listeners.push(unsubscribeItems);
        });
    }, (error) => {
        console.error("Error loading users for items:", error.message);
        alert("Error loading items: " + error.message);
    });

    // Store the unsubscribe function for users
    listeners.push(unsubscribeUsers);
}

// Updated logout function to clean up listeners
function logout() {
    // Unsubscribe all listeners
    listeners.forEach(unsubscribe => unsubscribe());
    listeners = []; // Clear the array

    signOut(auth).then(() => {
        localStorage.removeItem('loggedInUser');
        window.location.href = 'index.html';
    }).catch((error) => {
        console.error("Error logging out:", error.message);
        alert("Error logging out: " + error.message);
    });
}
